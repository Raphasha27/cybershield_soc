<!-- Header -->
<header class="header">
  <div class="header-content">
    <div class="logo-section">
      <div class="logo-icon">ğŸ›¡ï¸</div>
      <div class="logo-text">
        <h1>Kivoc Denamic Hub</h1>
        <span class="logo-subtitle">Internet Cafe Operations Center</span>
      </div>
    </div>
    
    <nav class="main-nav">
      <button class="nav-btn" [class.active]="currentView() === 'dashboard'" (click)="setView('dashboard')">
        <span class="nav-icon">ğŸ“Š</span>
        Dashboard
      </button>
      <button class="nav-btn" [class.active]="currentView() === 'threats'" (click)="setView('threats')">
        <span class="nav-icon">âš ï¸</span>
        Threats
      </button>
      <button class="nav-btn" [class.active]="currentView() === 'incidents'" (click)="setView('incidents')">
        <span class="nav-icon">ğŸš¨</span>
        Incidents
      </button>
      <button class="nav-btn" [class.active]="currentView() === 'vulnerabilities'" (click)="setView('vulnerabilities')">
        <span class="nav-icon">ğŸ”</span>
        Vulnerabilities
      </button>
      <button class="nav-btn" [class.active]="currentView() === 'compliance'" (click)="setView('compliance')">
        <span class="nav-icon">ğŸ“‹</span>
        Compliance
      </button>
    </nav>
    
    <div class="header-actions">
      <div class="search-bar">
        <input type="text" placeholder="Search security events..." (keyup.enter)="search($event)">
        <span class="search-icon">ğŸ”</span>
      </div>
      <button class="alert-btn" (click)="toggleAlertPanel()">
        <span class="alert-icon">ğŸ””</span>
        <span class="alert-badge">{{notifications().length}}</span>
      </button>
      <button class="ai-toggle-btn" (click)="toggleAI()">
        <span class="ai-icon">ğŸ¤–</span>
      </button>
      <button class="user-profile-btn" (click)="toggleProfileModal()">
        <div class="user-profile">
          <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=admin" alt="Admin">
          <span class="user-name">{{adminProfile().name}}</span>
        </div>
      </button>
    </div>
  </div>
</header>

<!-- Main Content -->
<main class="main-content">
  
  <!-- Dashboard View -->
  @if (currentView() === 'dashboard') {
    <section class="view active">
      <div class="threat-banner">
        <div class="threat-banner-content">
          <div class="threat-level">
            <span class="threat-icon">âš¡</span>
            <div class="threat-info">
              <div class="threat-title-row">
                <h3>Current Threat Level: <span class="threat-status" [style.color]="threatLevel() > 70 ? 'var(--color-critical)' : 'var(--color-warning)'">
                  {{ threatLevel() > 80 ? 'CRITICAL' : (threatLevel() > 60 ? 'ELEVATED' : 'MODERATE') }} ({{ threatLevel().toFixed(1) }}%)
                </span></h3>
                <button class="action-btn primary small" (click)="setView('threats')">View Details</button>
              </div>
              <p>Real-time heuristic analysis active</p>
            </div>
          </div>
          <div class="threat-gauge">
            <div class="gauge-fill" [style.width.%]="threatLevel()" [class.high]="threatLevel() > 70"></div>
          </div>
        </div>
      </div>

      <div class="metrics-grid">
        <div class="metric-card critical" (click)="setView('threats')">
          <div class="metric-header"><span class="metric-icon">ğŸ”´</span><h4>Critical Alerts</h4></div>
          <div class="metric-value"><span class="value">23</span><span class="trend up">+12%</span></div>
          <div class="metric-footer"><span class="metric-label">Last 24 hours</span></div>
        </div>
        <div class="metric-card warning" (click)="setView('incidents')">
          <div class="metric-header"><span class="metric-icon">ğŸŸ¡</span><h4>Active Incidents</h4></div>
          <div class="metric-value"><span class="value">47</span><span class="trend down">-8%</span></div>
          <div class="metric-footer"><span class="metric-label">Requiring attention</span></div>
        </div>
        <div class="metric-card info" (click)="setView('vulnerabilities')">
          <div class="metric-header"><span class="metric-icon">ğŸ”µ</span><h4>Vulnerabilities</h4></div>
          <div class="metric-value"><span class="value">156</span><span class="trend up">+5%</span></div>
          <div class="metric-footer"><span class="metric-label">Unpatched systems</span></div>
        </div>
        <div class="metric-card success" (click)="setView('compliance')">
          <div class="metric-header"><span class="metric-icon">ğŸŸ¢</span><h4>Systems Protected</h4></div>
          <div class="metric-value"><span class="value">1,247</span><span class="trend neutral">0%</span></div>
          <div class="metric-footer"><span class="metric-label">Network devices</span></div>
        </div>
      </div>

      <div class="charts-grid">
        <div class="chart-card large">
          <div class="card-header">
            <h3>Threat Activity Timeline</h3>
            <div class="chart-controls">
              <button class="chart-btn active">24H</button>
              <button class="chart-btn">7D</button>
              <button class="chart-btn">30D</button>
            </div>
          </div>
          <div class="chart-container">
            <canvas id="threatTimelineChart"></canvas>
          </div>
        </div>

        <div class="chart-card medium">
          <div class="card-header"><h3>Attack Sources</h3></div>
          <div class="attack-sources">
            <div class="source-item">
              <span class="country-flag">ğŸ‡¨ğŸ‡³</span>
              <span class="country-name">China</span>
              <div class="source-bar"><div class="bar-fill" style="width: 78%"></div></div>
              <span class="source-count">2,847</span>
            </div>
            <div class="source-item">
              <span class="country-flag">ğŸ‡·ğŸ‡º</span>
              <span class="country-name">Russia</span>
              <div class="source-bar"><div class="bar-fill" style="width: 65%"></div></div>
              <span class="source-count">2,341</span>
            </div>
          </div>
        </div>
      </div>

      <div class="dual-section">
        <div class="section-card">
          <div class="card-header">
            <h3>Recent Security Incidents</h3>
            <button class="view-all-btn" (click)="setView('incidents')">View All â†’</button>
          </div>
          <div class="incidents-list">
            @for (inc of incidents().slice(0, 5); track inc.id) {
              <div class="incident-item" [class]="inc.severity" (click)="openIncident(inc)">
                <div class="incident-header">
                  <span class="incident-title">{{inc.type}}</span>
                  <span class="incident-time">{{inc.time}}</span>
                </div>
                <p class="incident-description">{{inc.id}}: {{inc.description}}</p>
              </div>
            }
          </div>
        </div>

        <div class="section-card">
          <div class="card-header">
            <h3>Network Traffic Monitor</h3>
            <span class="live-indicator">ğŸ”´ LIVE</span>
          </div>
          <div class="traffic-visualization">
             <canvas id="networkTrafficChart"></canvas>
          </div>
          <div class="traffic-stats">
            <div class="stat-item"><span class="stat-label">Inbound</span><span class="stat-value">2.4 GB/s</span></div>
            <div class="stat-item"><span class="stat-label">Outbound</span><span class="stat-value">1.8 GB/s</span></div>
            <div class="stat-item"><span class="stat-label">Blocked</span><span class="stat-value">347 MB/s</span></div>
          </div>
        </div>
      </div>

      <div class="terminal-card">
        <div class="terminal-header">
          <div class="terminal-controls">
            <span class="control-dot red"></span>
            <span class="control-dot yellow"></span>
            <span class="control-dot green"></span>
          </div>
          <div class="terminal-title">cybershield_soc_v2.0.0 -- angular_host -- (80x24)</div>
        </div>
        <div class="terminal-body" #systemTerminal>
          @for (log of logs(); track log.timestamp) {
            <div class="log-line">
              <span class="log-timestamp">[{{log.timestamp}}]</span>
              <span class="log-tag" [class]="log.level">{{log.level.toUpperCase()}}</span>
              <span class="log-message">{{log.msg}}</span>
            </div>
          }
        </div>
      </div>
    </section>
  }

  <!-- Threats View -->
  @if (currentView() === 'threats') {
    <section class="view active">
      <div class="view-header"><h2>Threat Intelligence Center</h2></div>
      <div class="threats-table-container">
        <table class="threats-table">
          <thead>
            <tr>
              <th>Threat ID</th>
              <th>Type</th>
              <th>Severity</th>
              <th>Source IP</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            @for (threat of threats(); track threat.id) {
              <tr>
                <td style="color: var(--color-primary)">{{threat.id}}</td>
                <td>{{threat.type}}</td>
                <td><span class="severity-badge" [class]="threat.severity">{{threat.severity}}</span></td>
                <td>{{threat.source}}</td>
                <td><span class="status-badge" [class]="threat.status.toLowerCase()">{{threat.status}}</span></td>
                <td><button class="table-action-btn" (click)="performThreatAction(threat)">Action</button></td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    </section>
  }

  <!-- Incidents View -->
  @if (currentView() === 'incidents') {
    <section class="view active">
      <div class="view-header"><h2>Incident Response (Kanban)</h2></div>
      <div class="incidents-kanban">
        @for (status of ['detected', 'investigating', 'containing', 'resolved']; track status) {
          <div class="kanban-column">
            <div class="column-header" [class]="status">
              <h4 style="text-transform: capitalize;">{{status}}</h4>
              <span class="count">{{getIncidentsByStatus(status).length}}</span>
            </div>
            <div class="column-body">
              @for (inc of getIncidentsByStatus(status); track inc.id) {
                <div class="kanban-card">
                  <div (click)="openIncident(inc)">
                    <div class="kanban-card-header">
                      <span class="kanban-card-id">{{inc.id}}</span>
                      <span class="severity-badge" [class]="inc.severity">{{inc.severity}}</span>
                    </div>
                    <div class="kanban-card-title">{{inc.type}}</div>
                  </div>
                  
                  <div class="kanban-card-actions">
                    @if (status === 'detected') {
                      <button (click)="updateIncidentStatus(inc.id, 'investigating')">Investigate â†’</button>
                    }
                    @if (status === 'investigating') {
                      <button class="back-btn" (click)="updateIncidentStatus(inc.id, 'detected')">â† Reset</button>
                      <button (click)="updateIncidentStatus(inc.id, 'containing')">Contain â†’</button>
                    }
                    @if (status === 'containing') {
                      <button class="back-btn" (click)="updateIncidentStatus(inc.id, 'investigating')">â† Back</button>
                      <button (click)="updateIncidentStatus(inc.id, 'resolved')">Resolve ğŸ—¸</button>
                    }
                    @if (status === 'resolved') {
                      <button class="back-btn" (click)="updateIncidentStatus(inc.id, 'containing')">â† Reopen</button>
                    }
                  </div>
                </div>
              }
            </div>
          </div>
        }
      </div>
    </section>
  }

  <!-- Vulnerabilities View -->
  @if (currentView() === 'vulnerabilities') {
    <section class="view active">
      <div class="view-header"><h2>Vulnerability Assessment</h2></div>
      <div class="vulnerabilities-list">
        @for (vuln of vulnerabilities(); track vuln.id) {
          <div class="vuln-item" [class]="vuln.severity">
            <div class="vuln-item-header">
              <h3 class="vuln-title">{{vuln.title}}</h3>
              <span class="vuln-cve">{{vuln.id}}</span>
            </div>
            <p class="vuln-description">{{vuln.description}}</p>
            <div class="vuln-footer">
              <span>CVSS: <strong style="color: var(--color-danger)">{{vuln.score}}</strong></span>
              <span>Systems: {{vuln.systems}}</span>
            </div>
          </div>
        }
      </div>
    </section>
  }
  <!-- Compliance View -->
  @if (currentView() === 'compliance') {
    <section class="view active">
      <div class="view-header">
        <h2>Compliance & Reporting</h2>
        <button class="action-btn primary" (click)="generateReport()">Generate Report</button>
      </div>

      <div class="compliance-frameworks">
        @for (framework of complianceFrameworks(); track framework.name) {
          <div class="framework-card">
            <div class="framework-header">
              <h3>{{framework.name}}</h3>
              <span class="compliance-score">{{framework.score}}%</span>
            </div>
            <div class="compliance-bar">
              <div class="compliance-fill" [style.width.%]="framework.score"></div>
            </div>
            <p class="framework-status">{{framework.status}}</p>
          </div>
        }
      </div>
    </section>
  }

</main>

<!-- Incident Modal -->
@if (isModalOpen()) {
  <div class="modal active">
    <div class="modal-content">
      <div class="modal-header">
        <h3>{{selectedIncident()?.type}} - {{selectedIncident()?.id}}</h3>
        <button class="close-btn" (click)="closeModal()">âœ•</button>
      </div>
      <div class="modal-body">
        <p><strong>Status:</strong> <span class="status-badge investigating">{{selectedIncident()?.status}}</span></p>
        <p style="margin: 1rem 0;">{{selectedIncident()?.description}}</p>
        <div style="display: flex; gap: 1rem;">
          <button class="action-btn primary" (click)="isolateSystem()">Isolate System</button>
          <button class="action-btn" (click)="escalateIncident()">Escalate</button>
        </div>
      </div>
    </div>
  </div>
}

<!-- Notification Panel -->
<div class="notification-panel" [class.active]="isAlertPanelOpen()">
  <div class="panel-header">
    <h3>Security Alerts</h3>
    <button class="clear-btn" (click)="clearNotifications()">Clear All</button>
  </div>
  <div class="notifications-list">
    @for (note of notifications(); track note.id) {
      <div class="notification-item" [class]="note.type">
        <div class="notification-header">
          <span class="notification-icon">{{note.type === 'critical' ? 'ğŸ”´' : 'ğŸŸ¡'}}</span>
          <span class="notification-title">{{note.title}}</span>
        </div>
        <div class="notification-body">{{note.message}}</div>
      </div>
    }
    @if (notifications().length === 0) {
      <div class="empty-notifications">No new alerts</div>
    }
  </div>
</div>

<!-- AI Assistant Sidebar -->
<div class="ai-sidebar" [class.active]="isAIPanelOpen()">
  <div class="ai-header">
    <div class="ai-title">
      <span class="ai-bot-icon">ğŸ¤–</span>
      <div>
        <h3>CyberSentinel AI</h3>
        <span class="ai-status">Ready to assist</span>
      </div>
    </div>
    <button class="close-btn" (click)="toggleAI()">âœ•</button>
  </div>
  
  <div class="ai-chat-body" #aiChatBody>
    @for (msg of aiMessages(); track $index) {
      <div class="chat-message" [class.user]="msg.role === 'user'" [class.bot]="msg.role === 'bot'">
        <div class="message-bubble">{{msg.text}}</div>
      </div>
    }
  </div>

  <div class="ai-input-area">
    <input type="text" #aiInput placeholder="Ask CyberSentinel about threats..." (keyup.enter)="sendAIMessage(aiInput.value); aiInput.value = ''">
    <button class="send-btn" (click)="sendAIMessage(aiInput.value); aiInput.value = ''">â¬†ï¸</button>
  </div>
  
  <div class="ai-suggestions">
    <button (click)="aiInput.value = 'Analyze current threat level'">Analyze Threats</button>
    <button (click)="aiInput.value = 'Summarize latest incidents'">Recent Incidents</button>
  </div>
</div>

<!-- Toast Notifications -->
<div class="toast-container">
  @for (toast of toasts(); track toast.id) {
    <div class="toast" [class]="toast.type">
      <span class="toast-icon">{{toast.icon}}</span>
      <span class="toast-message">{{toast.message}}</span>
    </div>
  }
</div>

<!-- Profile Edit Modal -->
@if (isProfileModalOpen()) {
  <div class="modal active profile">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Edit Administrator Profile</h3>
        <button class="close-btn" (click)="toggleProfileModal()">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="form-group" style="margin-bottom: 1.5rem;">
          <label style="display: block; font-size: 0.875rem; color: var(--color-text-secondary); margin-bottom: 0.5rem;">Full Name</label>
          <input type="text" #nameInput [value]="adminProfile().name" 
            style="width: 100%; background: var(--color-bg-tertiary); border: 1px solid var(--color-border); color: white; padding: 0.75rem; border-radius: var(--radius-md);" 
            placeholder="Enter name...">
        </div>
        <div class="form-group" style="margin-bottom: 1.5rem;">
          <label style="display: block; font-size: 0.875rem; color: var(--color-text-secondary); margin-bottom: 0.5rem;">Professional Role</label>
          <input type="text" #roleInput [value]="adminProfile().role" 
            style="width: 100%; background: var(--color-bg-tertiary); border: 1px solid var(--color-border); color: white; padding: 0.75rem; border-radius: var(--radius-md);" 
            placeholder="e.g. Senior Security Analyst">
        </div>
        <div class="form-group" style="margin-bottom: 1.5rem;">
          <label style="display: block; font-size: 0.875rem; color: var(--color-text-secondary); margin-bottom: 0.5rem;">Department</label>
          <input type="text" #deptInput [value]="adminProfile().department" 
            style="width: 100%; background: var(--color-bg-tertiary); border: 1px solid var(--color-border); color: white; padding: 0.75rem; border-radius: var(--radius-md);" 
            placeholder="e.g. SOC Team Alpha">
        </div>
        <div class="modal-bottom-actions" style="display: flex; gap: 1rem; margin-top: 2rem;">
          <button class="action-btn primary" style="flex: 1;" (click)="saveProfile(nameInput.value, roleInput.value, deptInput.value)">Save Changes</button>
          <button class="action-btn" style="flex: 1;" (click)="toggleProfileModal()">Cancel</button>
        </div>
      </div>
    </div>
  </div>
}
